<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		<link rel="stylesheet" href="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/themes/css/cartodb.css"></link>
		<script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js"></script>
		<script src="https://leaflet.github.io/Leaflet.label/leaflet.label.js"></script> <!-- files necessary for labels in leaflet -->
		<script type="text/javascript" src="https://stamen-maps.a.ssl.fastly.net/js/tile.stamen.js"></script><!--Include Stamen JavaScript to get basemap tiles-->
		
		<!-- Include jquery -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		
		<!-- Include the include files: global vars and display text -->
		<script src="global.js" type="text/javascript" /></script>
		<script src="display_English.js" type="text/javascript"></script>
		
		<!-- Include the CSS styling -->
		<link rel="stylesheet" type="text/css" href="map_styles.css"></link>
		
		<!-- Include both libraries for plotting stamen basemaps --> 
		<script type="text/javascript" src="https://stamen-maps.a.ssl.fastly.net/js/tile.stamen.js"></script><!--Include Stamen JavaScript to get basemap tiles-->
		
		<!-- Include stuff required for easy full-screen option --> 
		<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
		<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />
		
	</head>
	
	<body onload="init();"> 	<!-- what to do when the page loads -->
		<div id='WaterMap'> 	<!-- creates the div element that holds the map -->
			<a href="http://www.caminosdeagua.org" target='_blank'> <!-- Link the caminos logo to the caminos website -->
				<img class="caminos_logo" src="https://dl.dropboxusercontent.com/s/ligsjij2ka26gi0/caminos_logo_circle.png" ></img> <!-- creates the caminos de agua logo -->
			</a>
			<!-- This next div is the legend -->
			<div class='cartodb-legend custom' id='legend' style="display: block;">	
				<div class="legend-title", id="legend_title" style="font-size:14px;"></div>
				<ul>
					<li>
						<div class="bullet" style="background:#24de17; text-transform:none" name="project_type"></div> 
					</li>
					<li>
						<div class="bullet" style="background:#2eb7ff; text-transform:none" name="project_type"></div>
					</li>
					<br>
					<li>
						<div class="bullet" style="background:#b700ff; text-transform:none" name="project_type"></div>
					</li>
					<li>
						<div class="bullet" style="background:#ff00ab; text-transform:none" name="project_type"></div>
					</li>
					<li>
						<div class="bullet" style="background:#f71c23; text-transform:none" name="project_type"></div>
					</li>
					<li>
						<div class="bullet" style="background:#ff6b12; text-transform:none" name="project_type"></div>
					</li>
				</ul>
			</div>
		</div>
		<div id='info_panel'>
			<img id="x-butt" onclick="closeInfoPanel();" src='https://dl.dropboxusercontent.com/s/vbfkb0s3tvf2q50/bigX.png'></img>
			<div class="info_text" id="proj_name"></div>
			<div class="info_text" id="photo"><img id="photo_box"></img></div>
			<div class="info_text" id="name"></div>
			<div class="info_text" id="muni"></div>
			<div class="info_text" id="proj_type"></div>
			<div class="info_text" id="site"></div>
			<div class="info_text" id="dates"></div>
			<div class="info_text" id="people"></div>
			<div class="info_text" id="workshops"></div>
			<div class="info_text" id="no_ceramic_systems"></div>
			<div class="info_text" id="no_ceramic_filters"></div>
			<div class="info_text" id="no_biochar"></div>
			<div class="info_text" id="no_ferro"></div>
			<div class="info_text" id="no_roto_small"></div>
			<div class="info_text" id="no_roto_large"></div>
			<div class="info_text" id="no_geomembrane"></div>
			<div class="info_text" id="no_underground"></div>
			<div class="info_text" id="partner"></div>
			<div class="info_text" id="primary_contact"></div>
			<div class="info_text" id="contact_info"></div>
			<div class="info_text" id="notes"></div>
			<div class="info_text" id="docs"></div>
		</div>

		<script>
		
			////////////////////////////////////////////////////////////////////////////////
			////					 INITIALIZATION FUNCTION 						  	////
			//////////////////////////////////////////////////////////////////////////////// 

			function init() {
				fillText();
				initMap(); 					// Initialize and display the map object
				applyBaseMap(); 			// Apply the base tiles to the map
				loadAndPlotData(); 	// Load the data for Fluoride (the default contaminant) 
			}								// 	then plot the base markers on the map.	
			
			////////////////////////////////////////////////////////////////////////////////
			////					  	fillText FUNCTION	 						  	////
			//// 			Fills out all text from appropriate language .js file.		////
			////////////////////////////////////////////////////////////////////////////////
			
			function fillText() {
				document.getElementById("legend_title").innerHTML = LEGEND_TITLE;
				els = document.getElementsByName("project_type");
				for(var i=0; i<els.length; i++){
					els[i].innerHTML = LEGEND_TEXT[i];
				}
			}
			
			
			////////////////////////////////////////////////////////////////////////////////
			////					  	initMap FUNCTION	 						  	////
			//// 			This function initializes the global map object.			////
			////////////////////////////////////////////////////////////////////////////////
			
			function initMap() {
				map = new L.map('WaterMap', { //First, initialize the map
					center: MAP_CENTER,
					zoom: MAP_INIT_ZOOM,
					minZoom: MAP_MIN_ZOOM,
					maxZoom: MAP_MAX_ZOOM,
					attributionControl: true,
					fullscreenControl: false
				});	
				map.attributionControl.setPrefix(ATTRIBUTION);
			}
			
			////////////////////////////////////////////////////////////////////////////////
			////					  	applyBaseMap FUNCTION 						  	////
			//// 	This function grabs a set of Stamen or Mapzen base tiles and 		////
			//// 	applies them to the map. 											////
			////////////////////////////////////////////////////////////////////////////////
			
			
			function applyBaseMap() {
				map.addLayer(new L.StamenTileLayer(STAMEN_MAP_TYPE), {});
				
			}
			
			////////////////////////////////////////////////////////////////////////////////
			////					 	loadAndPlotData FUNCTION 					  	////
			//// 	This function grabs data from carto.com and stores it in a local 	////
			//// 	variable array. It also stores a copy of the data in the global 	////
			////	array data for other functions to access. After storing the 		////
			////	data, it calls functions to plot them. 								////
			////////////////////////////////////////////////////////////////////////////////
			
			function loadAndPlotData() {

				base.Markers = [];
				base.Popups = [];
				
				$.getJSON(DATA_URL) 		// This grabs the JSON data file. MAKE SURE THE FILE IS SORTED BY 
											//	DATE IN DECREASING ORDER!!!! <--- Super important for spidering to work correctly...
				.done(function(data) {
					AllData = data; 		// store data as global for later access.
					// (Un)comment the next line to (see) hide the full dataset (in) from the console, super useful for debugging!
					console.log("Data acquired! "+JSON.stringify(data)); 	// log the data in the console for debugging...
					for (var i=0; i<data.length; i++) { // Loop through all the rows of the data
						var bin = getBin(data, i)
						if (data[i][DATA_NAMES.name] == null | data[i][DATA_NAMES.name] == "" |	// if there's no date or latLng info, 
							data[i][DATA_NAMES.lat] == null | data[i][DATA_NAMES.lat] == "" |	//	ignore the point!
							data[i][DATA_NAMES.lng] == null | data[i][DATA_NAMES.lng] == "" |
							bin == -1) {
						} else {
							
							var icon = L.icon({ 			// 	to be used when displaying the base markers
								iconUrl: ICON_URLS[bin],
								iconSize: SMALL_ICON_SIZE
							})
							var latLng = L.latLng([data[i][DATA_NAMES.lat], data[i][DATA_NAMES.lng]]); // Grab the latLng of the point			
							used_indices.push(i);
							base.Markers.push( 										// Save the appropriate marker
								L.marker(latLng, {
									icon: icon,
									riseOnHover: true,
									zIndexOffset: BASE_Z_OFFSET
								})
								.on('click', function(event) {
									click_lat = event.latlng.lat; 					// Grab the latLng of the cliked point 
																			// 	(returns value of marker's center, regardless of where is clicked...)
									
									
									var j = base.Markers.map(function(a) {return a._latlng.lat}).indexOf(click_lat);
																			// this confusing line gets the index in base.Markers
																			//	of the point with the same latitude as the clicked point
																			// 	we'll use that index to access the marker, label, and data.
									var z = used_indices[j];
									
									if (!info_panel_open) {
										info_being_displayed = z;
										showInfo(z);
										openInfoPanel();
									} else if (info_panel_open && info_being_displayed != z) {
										info_being_displayed = z;
										showInfo(z);
									}
								})
							);
							base.Markers[base.Markers.length-1].bindLabel(getLabel(data, i), {
								noHide: false,										// attach labels to all the base points 
								className: "ourLabel"								//	that activate during mouseover
							});
							base.Markers[base.Markers.length-1].addTo(map); // And finally, actually add the markers to the map!
						};
					};
				})
			}
			
			////////////////////////////////////////////////////////////////////////////////
			////					 	getBin FUNCTION 					  			////
			//// 	Gets the correct bin of the point. Does so with the 				////
			////	following algorithm:												////
			////		Bin 0: Has a geomembrane, underground, or large rotoplas cistern////
			////		Bin 1: Not bin 0 and has a small cistern.						////
			////		Bin 4: Not bin 0,1 and has a biochar systems					////
			////		Bin 2: Not bins 0,1,4 and has ceramic filter systems			////
			////		Bin 3: Not bins 0,1,4, 2 and has ceramic filters (but not 		////
			////			systems).													////
			////		Bin 5: Not bins 0,1,4,2,3 and has had a training (no install).	////
			////////////////////////////////////////////////////////////////////////////////
			
			function getBin(data, i) {
				var bin = -1;
				if (
				data[i][DATA_NAMES.no_underground] | 
				data[i][DATA_NAMES.no_geomembrane] |
				data[i][DATA_NAMES.no_roto_big]) {
					bin = BIG_CISTERN_BIN;
				} else if (
				data[i][DATA_NAMES.no_roto_small] | 
				data[i][DATA_NAMES.no_ferro] ) {
					bin = SMALL_CISTERN_BIN;
				} else if (
				data[i][DATA_NAMES.no_biochar] ) {
					bin = BIOCHAR_BIN;			
				} else if (
				data[i][DATA_NAMES.no_ceramic_filters] ) {
					bin = CERAMIC_FILTER_BIN;
				} else if (
				data[i][DATA_NAMES.no_ceramic_systems] ) {
					bin = CERAMIC_SYSTEM_BIN;
				} else if (
				data[i][DATA_NAMES.big_train] | 
				data[i][DATA_NAMES.small_train] ) {
					bin = TRAINING_BIN;
				} 
				return bin
			}
			
			////////////////////////////////////////////////////////////////////////////////
			////			openInfoPanel & closeInfoPanel FUNCTIONs		  			////
			//// 	Opens and closes the info panel respectivel. Duh.					////
			////////////////////////////////////////////////////////////////////////////////
			
			function openInfoPanel() {
				var el = document.getElementById("info_panel");
				el.style.opacity = 0; 				// Since the info panel isn't open, make sure opacity is 0
				el.style.display = "block";			//	but the panel isn't hidden, so it can be scrolled. 
				$("#info_panel").scrollTop(0);		// Since we're opening a new point, scroll to top of info window
				fadeIn(el)							// Once it's scrolled, fade the info window in.
				info_panel_open = true;				// And set the global to show that it's being displayed.
			}
			function closeInfoPanel() { 			// To close the panel:
				var el = document.getElementById("info_panel");
				fadeOut(el)							// Just fade it out.
				info_panel_open = false;			// Then reset the global to show it's hidden. 
			}
			
			////////////////////////////////////////////////////////////////////////////////
			////						showInfo FUNCTION					  			////
			//// 	Gets the correct information from the global dataset, then pushes	////
			////	it into the correct places in the info panel. 						////
			////////////////////////////////////////////////////////////////////////////////
			
			function showInfo(z) {
				var currentElement = 0;
				var elementsBeingDisplayed = 0;
				var els = document.getElementsByClassName("info_text");
				for(var i=0; i<els.length; i++) { 		// Loop through all the elements to fill
					var toDisplay = false;
					var id = els[i].id;					// Grab the id of the current element
					els[i].style.margin = "5px";		// Reset the margin property to the default values									
					// A few ids have special cases: 
					//	photo, 
					//	dates, 
					//	workshops, 
					// 	contact_info
					//	and docs.
					if (id == "dates") {
					} else if (id == "photo") {
						if (AllData[z][DATA_NAMES[id]] == null | AllData[z][DATA_NAMES[id]] == "" ) {}
						else {
							toDisplay = true;
							document.getElementById("photo_box").src = AllData[z][DATA_NAMES[id]]
							document.getElementById("photo_box").href = AllData[z][DATA_NAMES[id]]
						}
					} else if (id == "workshops") {
					} else if (id == "contact_info") {
					} else if (id == "docs") {
					} else {					// The rest are just text that need to be displayed with a label:
						if (AllData[z][DATA_NAMES[id]] == null | AllData[z][DATA_NAMES[id]] == "" ) {
					
						} else {
							toDisplay = true;
							if (LBL[id] != "") {
								els[i].innerHTML = LBL[id]+":<br>\xa0\xa0\xa0"+AllData[z][DATA_NAMES[id]];	
							} else {
								els[i].innerHTML = "<big><b>"+AllData[z][DATA_NAMES[id]]+"</big></b>";
							}
						}
					}
					if (toDisplay) {
						currentElement = i;
						if(elementsBeingDisplayed%2) {
							els[i].style.backgroundColor = "rgba(46, 183, 255, 0.4)";
						} else {
							els[i].style.backgroundColor = "rgba(255, 148, 0, 0.4)"
						}
						els[i].style.display = "block";
						elementsBeingDisplayed++;
					} else {
						els[i].style.display = "none";
					}				
				}
				els[currentElement].style.marginBottom = "25px";
				
				
				
				
				
				
				
				
				$("#info_panel").animate({scrollTop: 0}, SCROLL_TIME);	// First, scroll the info window back to the top.
			}
			
			////////////////////////////////////////////////////////////////////////////////
			////					 	getLabel FUNCTION 							  	////
			//// 	Takes in the type of label to plot (string) and the index of the 	////
			////	marker's data in the global data array, data. Returns the string ////
			////	that will be contained in the label. 								////
			////////////////////////////////////////////////////////////////////////////////
	
			function getLabel(data, i) {
				str = String(data[i][DATA_NAMES.name]);
				str = str.split(" ")
				var newStr = "";
				var lineCount = 1;
				for (var i=0; i<str.length; i++) {
					tempNewStr = newStr+"\xa0"+str[i]
					if(tempNewStr.length>MAX_LABEL_LINE_CHARS*lineCount & i!=0) {	
						newStr = newStr+"\xa0\n\xa0"+str[i];
					} else {
					newStr = tempNewStr;
					}
				};
				return "\xa0"+newStr+"\xa0";	
			}
			
			
			////////////////////////////////////////////////////////////////////////////////
			////					 	removePoint FUNCTION 						  	////
			//// 			Removes the point stored at the index i.					////
			////////////////////////////////////////////////////////////////////////////////
			
			function removePoint(i) {
				map.removeLayer(base.Markers[i]); 
			}
			
			
			
			////////////////////////////////////////////////////////////////////
			////				functions fadeIn(el), fadeOut(el) 			////
			//// 															////
			////	Fades in or out the passed element by adjusting the 	////
			////	the div element's opacity in steps. Many thanks to:		////////////////////
			////	http://www.chrisbuttery.com/articles/fade-in-fade-out-with-javascript/ 	////	
			////	for this simple and lovely bit of js. Cheers! 							////
			////	If the div is visible, fadeIn does nothing. If it's not, fade out 		////	
			////	does nothing. 															////
			////////////////////////////////////////////////////////////////////////////////////
			
			function fadeOut(el){ 
				
				(function fade() {
					if ((el.style.opacity -= .09) < 0) {
						el.style.opacity = 0;
					} else {
						requestAnimationFrame(fade);
					}
				})();
				
				el.style.display = 'none';
			}
			
			function fadeIn(el){
			
				el.style.opacity = 0;
				el.style.display = 'block'; 
				
				(function fade() {
					var val = parseFloat(el.style.opacity);
					if (!((val += .075) > 1)) {
					el.style.opacity = val;
					requestAnimationFrame(fade);
					}
				})();
				
			}
			
			$(document).bind('keypress', function (event) {
				if(String(event.originalEvent.key) == "Escape" && info_panel_open) {
					closeInfoPanel();
				}
			})
	
			
		</script>
		
	</body>
</html>
			
