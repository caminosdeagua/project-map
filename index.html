<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
		
		<!-- cartodb css -->	<link rel="stylesheet" href="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/themes/css/cartodb.css"></link>
		<!-- cartodb js -->		<script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.15/cartodb.js"></script>
		<!-- leaflet label -->	<script src="https://leaflet.github.io/Leaflet.label/leaflet.label.js"></script> <!-- files necessary for labels in leaflet -->
		<!-- stamen js -->		<script type="text/javascript" src="https://stamen-maps.a.ssl.fastly.net/js/tile.stamen.js"></script><!--Include Stamen JavaScript to get basemap tiles-->
		<!-- media player -->	<script src="mediaelement-and-player.min.js"></script>
		
		<!-- jquery -->			<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		<!-- global vars -->	<script src="https://caminosdeagua.github.io/project-map/global.js" type="text/javascript" /></script>
		<!-- dataset!!! -->		<script src="https://caminosdeagua.github.io/project-map/data/project_map_dataset.js" type="text/javascript" /></script>
		
		<!-- All language changes happen here!!!! -->
		<!--------------------------------------------------------------------------------------------------->
		<!-- CSS styles --> 	<link href="map_styles_English.css" rel="stylesheet" type="text/css"></link>
		<!-- display text -->	<script src="display_English.js" type="text/javascript"></script>
		<!---------------------------------------------------------------------------------------------------->
		
		<!-- stamen tiles -->	<script type="text/javascript" src="https://stamen-maps.a.ssl.fastly.net/js/tile.stamen.js"></script><!--Include Stamen JavaScript to get basemap tiles-->
		
		<!-- mapbox fullscrn-->	<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
		<!-- mapbox fullscrn-->	<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />
		
		<!--functional tiles--> <script type="text/javascript" src="functionaltilelayer.js"></script>
		
		<!--odometer css	-->	<link rel="stylesheet" href="counter/odometer-theme-default.css" />
		<!--odometer js		-->	<script type="text/javascript" src="counter/odometer.js"></script>
		
		<script>
		document.title = TITLE;
		</script>
	</head>
	
	<body onload="init();"> 	<!-- what to do when the page loads -->
		<div id='WaterMap'> 	<!-- creates the div element that holds the map -->
			<a href="http://www.caminosdeagua.org" target='_blank'> <!-- Link the caminos logo to the caminos website -->
				<img class="caminos_logo" src="https://caminosdeagua.github.io/project-map/img/caminos_logo_circle.png"></img> <!-- creates the caminos de agua logo -->
			</a>
			<!-- This next div is the legend -->
			<div class='cartodb-legend custom' id='legend' style="display: block; background-color: #dddddd;">	
				<div class="legend-title", id="legend_title" style="font-size:14px;"></div>
				<ul>
					<li>
						<div class="bullet" style="background:#24de17; text-transform:none" name="project_type"></div> 
					</li>
					<li>
						<div class="bullet" style="background:#2eb7ff; text-transform:none" name="project_type"></div>
					</li>
					<li>
						<div class="bullet" style="background:#b700ff; text-transform:none" name="project_type"></div>
					</li>
					<li>
						<div class="bullet" style="background:#df3099; text-transform:none" name="project_type"></div>
					</li>
					<li>
						<div class="bullet" style="background:#ffffff; text-transform:none" name="project_type"></div>
					</li>
				</ul>
			</div>
			
			
			<div id="stats_box">
				<div class = "stats_tr">
					<p class="stats_left"></p>
					<p class="odometer" id="stats_projects_no"></p>
				</div>
				<div class = "stats_tr">
					<p class="stats_left"></p>
					<p class="odometer" id="stats_people_no"></p>
				</div>
				<div class = "stats_tr">
					<p class="stats_left"></p>
					<p class="odometer" id="stats_capacity_no"></p>
				</div>
				<div class = "stats_tr">
					<p class="stats_left"></p>
					<p class="odometer" id="stats_ceramic_no"></p>
				</div>
			</div>
			
			<div id='info_panel' class='display_box' onmouseenter="disableMapControls();" onmouseleave="enableMapControls();">
				<img id="x-butt" class='x-butt' onclick="goBack('x');" src="https://caminosdeagua.github.io/project-map/img/greyX.png"></img>
				<div class="info_text" id="back_button" onclick="goBack()"></div>
				<div class="info_text" id="proj_name"></div>
				<div class="info_text" id="video" style="text-align: center;">
					<iframe id="video_box" class="vid_box" width="560px" height="315px" frameborder="0" allowfullscreen></iframe>
				</div>
				<div class="info_text" id="photo" style="text-align: center;"><img id="photo_box" class="photo_box"></img></div>
				<div class="info_text" id="docs"></div>
				<div class="info_text" id="name"></div>
				<div class="info_text" id="muni"></div>
				<div class="info_text" id="proj_type"></div>
				<div class="info_text" id="site"></div>
				<div class="info_text" id="dates"></div>
				<div class="info_text" id="people"></div>
				<div class="info_text" id="workshops"></div>
				<div class="info_text" id="no_ceramic_systems"></div>
				<div class="info_text" id="no_ceramic_filters"></div>
				<div class="info_text" id="no_biochar"></div>
				<div class="info_text" id="no_ferro"></div>
				<div class="info_text" id="no_roto_small"></div>
				<div class="info_text" id="no_roto_big"></div>
				<div class="info_text" id="no_geomembrane"></div>
				<div class="info_text" id="no_underground"></div>
				<div class="info_text" id="partner"></div>
				<div class="info_text" id="notes1"></div>
				
			</div>
			<div id='lobby', class='display_box' onmouseenter="disableMapControls();" onmouseleave="enableMapControls();" >
				<img id="x-butt-l" class='x-butt' onclick="goBack('x');" src="https://caminosdeagua.github.io/project-map/img/greyX.png"></img>
				<div class="lobby_text" id="proj_name_l" style="text-align: center;"></div>
				<div class="lobby_text" id="photo_l" style="text-align: center;">
					<img id="photo_box_l" class='photo_box'></img>
				</div>
				<div class="lobby_text" id="video_l" style="text-align: center;">
					<iframe id="video_box_l" class="vid_box" width="560px" height="315px" frameborder="0" allowfullscreen></iframe>
				</div>
				<div class="lobby_text" id="summary" align="center">
					<p id="summary_header"></p>
					<table id="summary_table"> 
						<tr align="center">
							<td class="left_column" id="no_projects_title"></td>
							<td class="right_column" id="no_projects_value"></td>
						</tr>
						<tr align="center">
							<td class="left_column" id="ppl_served_title"></td>
							<td class="right_column" id="ppl_served_value"></td>
						</tr>
						<tr align="center">
							<td class="left_column" id="liters_title"></td>
							<td class="right_column" id="liters_value"></td>
						</tr>
						<tr align="center">
							<td class="left_column" id="ceramic_title"></td>
							<td class="right_column" id="ceramic_value"></td>
						</tr>	
					</table>					
				</div>
				<br>
				<div class="lobby_text" id="message_l" style="text-align: center;"></div>
				<div class="lobby_text" id="project_list" align="center"></div>
				
			</div>
		</div>
		

		<script>
		
			////////////////////////////////////////////////////////////////////////////////
			////					 INITIALIZATION FUNCTION 						  	////
			//////////////////////////////////////////////////////////////////////////////// 

			function init() {
				fillText();
				initMap(); 					// Initialize and display the map object
				applyBaseMap(); 			// Apply the base tiles to the map
				adjustXLocation();
				loadAndPlotData(); 			// Load the data for Fluoride (the default contaminant) 
											// 	then plot the base markers on the map.	
				fillCounters();				// Read the data for the counters
			}								
			
			////////////////////////////////////////////////////////////////////////////////
			////					  	fillText FUNCTION	 						  	////
			//// 			Fills out all text from appropriate language .js file.		////
			////////////////////////////////////////////////////////////////////////////////
			
			function fillText() {
				document.getElementById("legend_title").innerHTML = LEGEND_TITLE;
				els = document.getElementsByName("project_type");
				for(var i=0; i<els.length; i++){
					els[i].innerHTML = LEGEND_TEXT[i];
				}
				
				els = document.getElementsByClassName("stats_left");
				for (var i=0; i<els.length; i++) {
					els[i].innerHTML = SUMMARY_HEADERS[i];				
				}
				
				
			}
			
			////////////////////////////////////////////////////////////////////////////////
			////					  	fillCounters FUNCTION	 					  	////
			//// 			Fills out all counters by trolling through the dataset		////
			////////////////////////////////////////////////////////////////////////////////
			
			function fillCounters() {
				document.getElementById("stats_box").style.display = "inline-block";		// show the stats menu
				document.getElementById("stats_projects_no").innerHTML = totalProjects();	// fill it!
				document.getElementById("stats_people_no").innerHTML = totalPeople();
				document.getElementById("stats_capacity_no").innerHTML = totalCapacity();
				document.getElementById("stats_ceramic_no").innerHTML = totalCeramic();
			}
			
			
			////////////////////////////////////////////////////////////////////////////////
			////					  	initMap FUNCTION	 						  	////
			//// 			This function initializes the global map object.			////
			////////////////////////////////////////////////////////////////////////////////
			
			function initMap() {
				map = new L.map('WaterMap', { //First, initialize the map
					center: MAP_CENTER,
					zoom: MAP_INIT_ZOOM,
					minZoom: MAP_MIN_ZOOM,
					maxZoom: MAP_MAX_ZOOM,
					attributionControl: true,
					fullscreenControl: true
				});	
				map.attributionControl.setPrefix(ATTRIBUTION);
			}
			
			////////////////////////////////////////////////////////////////////////////////
			////					  	applyBaseMap FUNCTION 						  	////
			//// 	This function grabs a set of Stamen or Mapzen base tiles and 		////
			//// 	applies them to the map. 											////
			////////////////////////////////////////////////////////////////////////////////
			
			
			function applyBaseMap() {
				map.addLayer(new L.StamenTileLayer(STAMEN_MAP_TYPE), {});
				
			}
			
			////////////////////////////////////////////////////////////////////////////////
			////					  adjustXLocation FUNCTION 						  	////
			//// 	This function adjusts the location of the x-button that closes the	////
			////	info panel, lobby, or other windows. It puts it a set pixel distance////
			////	to the left of the scrollbar. 										////
			////////////////////////////////////////////////////////////////////////////////
			
			function adjustXLocation() {
				var xButtons = document.getElementsByClassName("x-butt");
				for (var i=0; i<xButtons.length; i++) {
					xButtons[i].style.right = String(getScrollBarWidth()+X_OFFSET_FROM_SCROLLBAR)+'px';
				}
			}
			
			////////////////////////////////////////////////////////////////////////////////
			////					 	loadAndPlotData FUNCTION 					  	////
			//// 	This function grabs data from carto.com and stores it in a local 	////
			//// 	variable array. It also stores a copy of the data in the global 	////
			////	array data for other functions to access. After storing the 		////
			////	data, it calls functions to plot them. 								////
			////////////////////////////////////////////////////////////////////////////////
			
			function loadAndPlotData() {

				base.Markers = [];
				base.Popups = [];
				selectedIcon = L.icon({
					iconUrl: SELECTED_URL,
					iconSize: LARGE_ICON_SIZE
				});
				var duplicateCounter = 0;
				var data = PROJECT_MAP_DATA;	// This grabs the JSON data file. 
				AllData = data; 				// store data as global for later access.
				photos = Array.apply(null, Array(data.length)).map(Boolean.prototype.valueOf,false); 	// init an array full of "false"'s to later populate with images
				// (Un)comment the next line to (see) hide the full dataset (in) from the console, super useful for debugging!
				//console.log("Data acquired! "+JSON.stringify(data)); 	// log the data in the console for debugging...
				
				for (var i=0; i<data.length; i++) { // Loop through all the rows of the data
					var bin;
					if (data[i][DATA_NAMES.name] == null | data[i][DATA_NAMES.name] == "" |	// if there's no date or latLng info, 
						data[i][DATA_NAMES.lat] == null | data[i][DATA_NAMES.lat] == "" |	//	ignore the point!
						data[i][DATA_NAMES.lng] == null | data[i][DATA_NAMES.lng] == "" |
						bin == -1) {
					
						
					} else {
						
						
						
						if (i==0 || data[i][DATA_NAMES.name] != data[i-1][DATA_NAMES.name]) {			// if not a duplicate point (special case for 0th point, cause 0-1 does not exist)
							duplicateCounter = 0;
							AllData[i].duplicates = [i]; 		// create a new array in AllData called duplicates to hold indices of duplicates of this point
							bin = getBin(data, i);
							AllData[i].bin = bin;
							if (data[i][DATA_NAMES.photo] == null | data[i][DATA_NAMES.photo] == "") { // if there's no photo, do nothing
							} else { 							// if there's a photo, get it from the link and store it in the browser
								photos[i] = new Image();
								photos[i].src = data[i][DATA_NAMES.photo];
							}
							
							
							
							
							var icon = L.icon({ 							// 	to be used when displaying the base markers
								iconUrl: ICON_URLS[bin],
								iconSize: SMALL_ICON_SIZE
							})
							var latLng = L.latLng([data[i][DATA_NAMES.lat], data[i][DATA_NAMES.lng]]); // Grab the latLng of the point			
							used_indices.push(i);
							base.Markers.push( 								// Save the appropriate marker
								L.marker(latLng, {
									icon: icon,
									riseOnHover: true,
									zIndexOffset: BASE_Z_OFFSET
								})
								.on('click', function(event) {
									
									click_lat = event.latlng.lat; 			// Grab the latLng of the cliked point 
																			// 	(returns value of marker's center, regardless of where is clicked...)
									var j = base.Markers.map(function(a) {return a._latlng.lat}).indexOf(click_lat);
																			// this confusing line gets the index in base.Markers
																			//	of the point with the same latitude as the clicked point
																			// 	we'll use that index to access the marker, label, and data.
									var z = used_indices[j];				// Then get the index of the point in AllData.
									
									if (AllData[z].duplicates.length > 1) { // if the current point HAS duplicates:
										if(!info_panel_open && !lobby_active) {		// and the info panel and lobby are both closed
											info_being_displayed = z;		// set the info to display as this point
											showLobby(z);					// show the lobby for this point, since it has multiple projects
									
											openPanel('lobby');				// open the info panel
										} else if ((info_panel_open || lobby_active) && info_being_displayed != z ) {	// if the info panel or lobby are open and not displaying this point
											info_being_displayed = z;		// change the info being displayed to this point
											closePanel('info_panel');
											showLobby(z);					// show the lobby since this point has multiple projects
											openPanel('lobby');
										}	 
									} else {								// If the selected point DOESN'T have duplicates
										if (!info_panel_open) {				// and the info panel is closed
											info_being_displayed = z;		// set the info being displayed to this point
																			// push the info for this community/project to the info panel
											if (lobby_active) {
												closePanel('lobby');			// close the lobby in case it's open
											}
											showInfo(z);
											openPanel('info_panel');				// open the info panel
										} else if (info_panel_open && info_being_displayed != z) {	// if the info panel is open, but showing a different point
											info_being_displayed = z;		// change the info being displayed to this point
											showInfo(z);					// push the current info to the info panel. 
										}
									}
									
								})
							);
							base.Markers[base.Markers.length-1].bindLabel(getLabel(data, i), {
								noHide: false,										// attach labels to all the base points 
								className: "ourLabel"								//	that activate during mouseover
							});
							base.Markers[base.Markers.length-1].addTo(map); 		// And finally, actually add the markers to the map!
					
					
					
						} else {													// if i is a duplicate
							duplicateCounter = duplicateCounter + 1;				// increment the duplicate counter
							AllData[i-duplicateCounter].duplicates.push(i);
							AllData[i].isDuplicate = true;
							AllData[i-1].isDuplicate = true;
							bin = getBin(data, i);
							AllData[i].bin = bin;
							if (AllData[i-1].bin == VARIOUS) {
								bin = VARIOUS;
							} else if (bin != AllData[i-1].bin) {
								bin = VARIOUS;
								AllData[i-1].bin = VARIOUS;
								
								map.removeLayer(base.Markers[base.Markers.length-1]);
								base.Markers[base.Markers.length-1].options.icon.options.iconUrl = ICON_URLS[VARIOUS];
								base.Markers[base.Markers.length-1].addTo(map);
							}
							AllData[i].bin = bin;	
							if (data[i][DATA_NAMES.photo] == null | data[i][DATA_NAMES.photo] == "") { // if there's no photo, do nothing
							} else { 							// if there's a photo, get it from the link and store it in the browser
								photos[i] = new Image();
								photos[i].src = data[i][DATA_NAMES.photo];
							}	
						}	
					};
				};
			}
			
			////////////////////////////////////////////////////////////////////////////////
			////					 	getBin FUNCTION 					  			////
			//// 	Gets the correct bin of the point. Does so with the 				////
			////	following algorithm:												////
			////		Bin 0: RWH														////
			////		Bin 1: Ceramic water filter										////
			////		Bin 2: Biochar system											////
			////////////////////////////////////////////////////////////////////////////////
			
			function getBin(data, i) {
				var bin = -1;
				if (data[i][DATA_NAMES.proj_type] == RAIN_PROJ) {
					bin = RAINWATER;
				} else if (data[i][DATA_NAMES.proj_type] == CERAMIC_PROJ) {
					bin = CERAMIC;
				} else if (data[i][DATA_NAMES.proj_type] == BIOCHAR_PROJ) {
					bin = BIOCHAR;
				} else if (data[i][DATA_NAMES.proj_type] == OTHER_PROJ) {
					bin = OTHER;
				}
				return bin
			}
			
			////////////////////////////////////////////////////////////////////////////////
			////			openInfoPanel & closeInfoPanel FUNCTIONs		  			////
			//// 	Opens and closes the info panel respectivel. Duh.					////
			////////////////////////////////////////////////////////////////////////////////
			
			function openPanel(id) {
				var el = document.getElementById(id);
				el.style.opacity = 0; 				// Since the info panel isn't open, make sure opacity is 0
				el.style.display = "block";			//	but the panel isn't hidden, so it can be scrolled. 
				$("#"+id).scrollTop(0);		// Since we're opening a new point, scroll to top of info window
				fadeIn(el)							// Once it's scrolled, fade the info window in.
				
				if (id == 'info_panel') {
					info_panel_open = true;				// And set the global to show that it's being displayed.
				} else if (id == 'lobby') {
					lobby_active = true;
				}
			}
			
			function closePanel(id) { 			// To close the panel:
				var el = document.getElementById(id);
				fadeOut(el)							// Just fade it out.
				
				if (id=='info_panel') {
					info_panel_open = false;			// Then reset the global to show it's hidden. 
				} else if (id == 'lobby') {
					lobby_active = false;
				}
				
														// This following chunk of code
				$('.vid_box').each(function(){		//	resets the video's source
					var el_src = $(this).attr("src");	//	which effectively resets the video,
					$(this).attr("src",el_src);			//	pausing or stopping it. 
				});
			}
			
			
			////////////////////////////////////////////////////////////////////////////////
			////						showInfo FUNCTION					  			////
			//// 	Gets the correct information from the global dataset, then pushes	////
			////	it into the correct places in the info panel. 						////
			////////////////////////////////////////////////////////////////////////////////
			
			function showInfo(z) {
				hideSelectedMarker();
				showSelectedMarker();
				var isVideo = false; 				//initialize a var that will say whether or not this point has a video
				var currentElement = 0;
				var elementsBeingDisplayed = 0;
				var els = document.getElementsByClassName("info_text");
				var i=0;
				for(i; i<els.length; i++) { 		// Loop through all the elements to fill
					var toDisplay = false;				// Initialize each element to not display in case there's no content. 
					var id = els[i].id;					// Grab the id of the current element
					els[i].style.margin = "5px";		// Reset the margin property to the default values									
					// A few ids have special cases: 
					//	photo, 
					//	dates, 
					//	workshops, 
					// 	contact_info
					//	and docs.
					if (id == "proj_name") {
						toDisplay = true;
						els[i].innerHTML = AllData[z][DATA_NAMES.name]+":<br><i>"
						if (AllData[z][DATA_NAMES.proj_type] == OTHER_PROJ) {
							if (AllData[z][DATA_NAMES.proj_name] != "" && AllData[z][DATA_NAMES.proj_name] != null) {
								els[i].innerHTML = els[i].innerHTML + AllData[z][DATA_NAMES.proj_name]+"</i>";
							}
						} else {
							els[i].innerHTML = els[i].innerHTML + AllData[z][DATA_NAMES.proj_type]+"</i>";
						}
					} else if (id == 'back_button') {
						els[i].innerHTML = BACK_BUTTON_TXT[0]+AllData[z][DATA_NAMES.name]+BACK_BUTTON_TXT[1];
						if (AllData[z].isDuplicate) {toDisplay = true;}
					} else if (id == "dates") {				// If there are dates, include them here:
						if ((AllData[z][DATA_NAMES.start_date] == null | AllData[z][DATA_NAMES.start_date] == "") &&
							(AllData[z][DATA_NAMES.end_date] == null | AllData[z][DATA_NAMES.end_date] == "")) {}
						else {
							toDisplay = true;
							var start_date = AllData[z][DATA_NAMES.start_date];
							var end_date = AllData[z][DATA_NAMES.end_date];
							var formattedDate;
							if (start_date == null | start_date == "") {
								formattedDate = String(end_date);
							} else if (end_date == null | end_date == "") {
								formattedDate = String(start_date);
							} else {
								if(end_date == start_date) {
									formattedDate = String(start_date);
								} else {
									formattedDate = String(start_date+BETWEEN_DATES+end_date);
								}
							}
							els[i].innerHTML = "<b>"+LBL[id]+"</b>"+END_OF_HEADER+formattedDate;
						}
					} else if (id == "video")
						if (AllData[z][DATA_NAMES[id]] == null | AllData[z][DATA_NAMES[id]] == "") {}
						else {
							toDisplay = true;
							isVideo = true;
							var video_element = document.getElementById("video_box");
							video_element.src = AllData[z][DATA_NAMES[id]];
					
					
					} else if (id == "photo") {			// If there's a photo, deal with it:
						if ((AllData[z][DATA_NAMES[id]] == null | AllData[z][DATA_NAMES[id]] == "") &&				
						(AllData[z][DATA_NAMES.photo_folder] == null | AllData[z][DATA_NAMES.photo_folder] == "" )) {	// if there's no photo don't display the photo box
						} else if (isVideo) {	// if there's a video, don't display the photo!					
						} else {
							toDisplay = true;
							var photoEl = document.getElementById("photo_box");
							if (AllData[z][DATA_NAMES.photo_folder] == null | AllData[z][DATA_NAMES.photo_folder] == "" ) { 	// if there's a photo but no link
								photoEl.src = photos[z].src;
							} else {																							// if there's a photo and a link
								photoEl.src = photos[z].src;
								photoEl.style.display = "block";
							
							}
						}
					} else if (id == "workshops") {		// If there were workshops, include them here:
						if ((AllData[z][DATA_NAMES.big_train] == null | AllData[z][DATA_NAMES.big_train] == "") &&
							(AllData[z][DATA_NAMES.small_train] == null | AllData[z][DATA_NAMES.small_train] == "")) {}
						else {
							toDisplay = true;
							if (AllData[z][DATA_NAMES.big_train] == null | AllData[z][DATA_NAMES.big_train] == "") {
								els[i].innerHTML = "<b>"+LBL.small_train+"</b>"+END_OF_HEADER+AllData[z][DATA_NAMES.small_train];	
							} else if (AllData[z][DATA_NAMES.small_train] == null | AllData[z][DATA_NAMES.small_train] == "") {
								els[i].innerHTML = "<b>"+LBL.big_train+"</b>"+END_OF_HEADER+AllData[z][DATA_NAMES.big_train];
							} else {
								els[i].innerHTML = "<b>"+LBL[id]+"</b>"+":<br>"+
								LBL.small_train+END_OF_HEADER+AllData[z][DATA_NAMES.small_train]+"<br>"+
								LBL.big_train+END_OF_HEADER+AllData[z][DATA_NAMES.big_train];
							}
						}
					}else if (id == "docs") {			// If there's a link to a document, include it here:
						if (AllData[z][DATA_NAMES[id]] == null | AllData[z][DATA_NAMES[id]] == "" ) {}
						else {
							toDisplay = true;
							els[i].innerHTML = "<a href='"+AllData[z][DATA_NAMES[id]]+"' target='_blank'>"+SEE_MORE+"</a>";
							els[i].style.textAlign = "center";
						}
					} else if (id == "notes1"){
						
						if (AllData[z][DATA_NAMES[id]] == null | AllData[z][DATA_NAMES[id]] == "" ) {}
						else if (AllData[z][DATA_NAMES.notes2] == null | AllData[z][DATA_NAMES.notes2] == "" ) {
							toDisplay = true;
							els[i].innerHTML = "<b>"+LBL[id]+"</b>"+END_OF_HEADER+AllData[z][DATA_NAMES.notes1];
							
						} else if (AllData[z][DATA_NAMES.notes3] == null | AllData[z][DATA_NAMES.notes3] == "" ) {
							toDisplay = true;
							els[i].innerHTML = "<b>"+LBL[id]+"</b>"+END_OF_HEADER+AllData[z][DATA_NAMES.notes1]+"\xa0"+AllData[z][DATA_NAMES.notes2];
						}
						else if (AllData[z][DATA_NAMES.notes4] == null | AllData[z][DATA_NAMES.notes4] == "" ) {
							toDisplay = true;
							els[i].innerHTML = "<b>"+LBL[id]+"</b>"+END_OF_HEADER+AllData[z][DATA_NAMES.notes1]+"\xa0"+AllData[z][DATA_NAMES.notes2]+"\xa0"+AllData[z][DATA_NAMES.notes3];
						}
						else if (AllData[z][DATA_NAMES.notes5] == null | AllData[z][DATA_NAMES.notes5] == "" ) {
							toDisplay = true;
							els[i].innerHTML = "<b>"+LBL[id]+"</b>"+END_OF_HEADER+AllData[z][DATA_NAMES.notes1]+"\xa0"+AllData[z][DATA_NAMES.notes2]+"\xa0"+AllData[z][DATA_NAMES.notes3]+"\xa0"+AllData[z][DATA_NAMES.notes4];
						} else {
							toDisplay = true;
							els[i].innerHTML = "<b>"+LBL[id]+"</b>"+END_OF_HEADER+AllData[z][DATA_NAMES.notes1]+"\xa0"+AllData[z][DATA_NAMES.notes2]+"\xa0"+AllData[z][DATA_NAMES.notes3]+"\xa0"+AllData[z][DATA_NAMES.notes4]+"\xa0"+AllData[z][DATA_NAMES.notes5];
						}
					
					
					
					} else {							// The rest are just text that need to be displayed with a label:
						if (AllData[z][DATA_NAMES[id]] == null | AllData[z][DATA_NAMES[id]] == "" ) {}
						else {
							toDisplay = true;
							if (LBL[id] != "") {
								els[i].innerHTML = "<b>"+LBL[id]+"</b>"+END_OF_HEADER+AllData[z][DATA_NAMES[id]];	
							} else {
								els[i].innerHTML = "<big><b>"+AllData[z][DATA_NAMES[id]]+"</big></b>";
							}
						}
					}
					if (toDisplay) {
						currentElement = i;
						
						if (els[i].id == 'back_button') {								// display for back button
							els[i].style.backgroundColor = "rgba(235, 235, 235, 0)";
							els[i].style.marginRight = "100px";
							els[i].style.textDecoration = "underline";
							els[i].onmouseenter = function(event) {
								event.target.style.color = '#63aec1';
							}
							els[i].onmouseleave = function(event) {
								event.target.style.color = 'black';
							}
							
						} else if (els[i].id == "photo") {								// display for photo frame
							els[i].style.backgroundColor = "rgba(235, 235, 235, 0)";
						} else if (els[i].id == "video") {								// display for video frame
							els[i].style.backgroundColor = "rgba(235, 235, 235, 0)";
						} else if(els[i].id=="proj_name") {								// display for project name
							els[i].style.fontSize = "20px";
							els[i].style.backgroundColor = "rgba(235, 235, 235, 0)";
							els[i].style.marginRight = "40px";
							els[i].style.fontWeight = "600";
							
						} else if (els[i].id=="docs") {									// display for links to more information/documentation
							els[i].style.backgroundColor = "rgba(235, 235, 235, 0)";
							els[i].style.fontSize = "18px";
						
						} else if(elementsBeingDisplayed%2) {							// display for every even element
							els[i].style.backgroundColor = "rgba(211, 233, 237, 1)";
						} else {														// display for every odd element
							els[i].style.backgroundColor = "rgba(166, 211, 218, 1)";
						}
						els[i].style.display = "block";
						elementsBeingDisplayed++;
					} else {
						els[i].style.display = "none";
					}				
				}
				els[currentElement].style.marginBottom = "25px";				// adjust the margin on the last element for clearance				
				$("#info_panel").animate({scrollTop: 0}, SCROLL_TIME);	// First, scroll the info window back to the top.
			}
			
			////////////////////////////////////////////////////////////////////////////////
			////						showLobby FUNCTION					  			////
			//// 	Gets the correct information from the global dataset, then pushes	////
			////	it into the correct places in the lobby.	 						////
			////////////////////////////////////////////////////////////////////////////////
			
			function showLobby(z) {
				hideSelectedMarker(); 
				showSelectedMarker();
				document.getElementById('message_l').innerHTML = LOBBY_MESSAGE[0];
				var els = document.getElementsByClassName("lobby_text");
				
				for (var i = 0; i<els.length; i++) {
					var id = els[i].id;					// Grab the id of the current element
					if (id == 'proj_name_l') {
						els[i].innerHTML = AllData[z][DATA_NAMES.name];
						els[i].style.fontSize = "32px";
						els[i].style.backgroundColor = "rgba(235, 235, 235, 0)";
						els[i].style.fontWeight = "600";
					} 
					else if (id == 'photo_l') {
						var photoCounter = 0;
						for (var j = 0; j<AllData[z].duplicates.length; j++) {		// loop through duplicates
							dup = AllData[z].duplicates[j];
							if (photoCounter == 0) {								// grab and display 1st photo
								if (AllData[dup][DATA_NAMES.photo] == null | AllData[dup][DATA_NAMES.photo] == "") {	
									document.getElementById("photo_l").style.display = 'none';	
								} else {
									photoCounter = 1;
									document.getElementById("photo_l").style.display = 'inline-block';
									document.getElementById("photo_box_l").src = photos[dup].src;	
									document.getElementById("photo_box_l").style.display = 'block';
								}	
							}
						}	
					}
					else if (id == "video_l") {
						var videoCounter = 0;
						for (var j = 0; j<AllData[z].duplicates.length; j++) {		// loop through duplicates
							dup = AllData[z].duplicates[j];
							if (videoCounter == 0) {	
								if (AllData[dup][DATA_NAMES.video] == null | AllData[dup][DATA_NAMES.video] == "") {	
									document.getElementById("video_l").style.display = 'none';
								} else {
									videoCounter = 1;
									document.getElementById("video_l").style.display = 'inline-block';
									document.getElementById("video_box_l").src = AllData[dup][DATA_NAMES.video];
									document.getElementById("photo_l").style.display = "none";
								}
							}
						}
					}
					else if (id == "summary") {
						document.getElementById("summary_header").innerHTML = SUMMARY_TITLE;
						var heads = document.getElementsByClassName("left_column");
						for (var i=0; i<heads.length; i++) {
							heads[i].innerHTML = SUMMARY_HEADERS[i];
						}
						document.getElementById('no_projects_value').innerHTML = projectsCompleted(z);
						document.getElementById('ppl_served_value').innerHTML = peopleImpacted(z);
						document.getElementById('liters_value').innerHTML = storageInstalled(z);
						document.getElementById('ceramic_value').innerHTML = filtersDistributed(z);
						
					}
					else if (id == "project_list") {
						
						for (var j = 0; j<AllData[z].duplicates.length; j++) {		// loop through duplicates
							dup = AllData[z].duplicates[j];
							rawDate = String(AllData[dup][DATA_NAMES.start_date]).split("-", 3);
							
							date = MONTHS_LONG[ENGLISH_MONTHS.indexOf(rawDate[1])]+", 20"+rawDate[2];
							var nameToDisplay = AllData[dup][DATA_NAMES.proj_type];
							var proj_name = AllData[dup][DATA_NAMES.proj_name]
							if (nameToDisplay == OTHER_PROJ && proj_name != "" && proj_name != null) {
								nameToDisplay = proj_name;
							}
							if (j==0) {
								els[i].innerHTML = "<p class='proj_box_even' onclick='openFromLobby("+String(dup)+");'>"+nameToDisplay+": "+date+"</p>";
							} else {
								if (j%2==0) {
									els[i].innerHTML = els[i].innerHTML+"<p class='proj_box_even' onclick='openFromLobby("+String(dup)+");'>"+nameToDisplay+": "+date+"</p>";
								} else {
									els[i].innerHTML = els[i].innerHTML+"<p class='proj_box_odd' onclick='openFromLobby("+String(dup)+");'>"+nameToDisplay+": "+date+"</p>";
								}
							}
						}	
					}
					
				}	
			}
			
			////////////////////////////////////////////////////////////////////////////////
			////						openFromLobby FUNCTION					  		////
			//// 	When a project is clicked in the lobby, this function opens the 	////
			////	info panel with the appropriate data called.						////
			////////////////////////////////////////////////////////////////////////////////
			
			function openFromLobby(z) {
				
				showInfo(z);
				openPanel('info_panel');
				closePanel('lobby');
			}
			
			////////////////////////////////////////////////////////////////////////////////
			////						projectsCompleted 	FUNCTION					////
			////						peopleImpacted 		FUNCTION					////
			////						storageInstalled	FUNCTION					////
			////						filetersDistributed	FUNCTION					////
			//// 	These functions agregate information from all of the duplicate 		////
			////	projects for the site at 'point' display a summary to the user. 	////
			////////////////////////////////////////////////////////////////////////////////
			
			
			function projectsCompleted(point) {
				return AllData[point].duplicates.length
			}
			
			function peopleImpacted(point) {
				var ppl = 0;
				var dup;
				for (var i=0; i<AllData[point].duplicates.length; i++) {
					dup = AllData[point].duplicates[i];
					ppl = ppl + AllData[dup][DATA_NAMES.people];
				}
				ppl = numberWithCommas(ppl);
				if (ppl == '0') {
					ppl = "unknown";
				}
				
				return ppl
				
			}
			
			function storageInstalled(point) {
				var storage = 0;
				var dup;
				for (var i=0; i<AllData[point].duplicates.length; i++) {
					dup = AllData[point].duplicates[i];
					storage = storage + 12000*AllData[dup][DATA_NAMES.no_ferro] + 2500*AllData[dup][DATA_NAMES.no_roto_small] + 10000*AllData[dup][DATA_NAMES.no_roto_big] + 30000*AllData[dup][DATA_NAMES.no_geomembrane] + 80000*AllData[dup][DATA_NAMES.no_underground]; //+ 2000*AllData[dup][DATA_NAMES.no_rainjar];
				}
				storage = numberWithCommas(storage);
				
				return storage
				
			}
			
			function filtersDistributed(point) {
				var filters = 0;
				var dup;
				for (var i=0; i<AllData[point].duplicates.length; i++) {
					dup = AllData[point].duplicates[i];
					filters = filters + Number(AllData[dup][DATA_NAMES.no_ceramic_systems]) + Number(AllData[dup][DATA_NAMES.no_ceramic_filters]);
				}
				filters = numberWithCommas(filters);
				return filters
			}
			
			////////////////////////////////////////////////////////////////////////////////
			////						totalProjects 	FUNCTION						////
			////						totalPeople		FUNCTION						////
			////						totalCapacity	FUNCTION						////
			////						totalCeramic	FUNCTION						////
			//// 	These functions agregate information from all of the duplicate 		////
			////	projects over all of the sites. Can only be called once all the 	////
			////	data has been loaded. Each one loops through all of the base points	////
			////	aggregating the grouped data from all of the base points.			////
			////	Returns: int														////
			////////////////////////////////////////////////////////////////////////////////
			
			function totalProjects() {
				var total = 0
				for (var i=0; i<used_indices.length; i++) {				// loop through all base points
					total = total + projectsCompleted(used_indices[i]);	// add up all projects from all and their duplicates
				}
				return total;
			}
			
			function totalPeople() {
				var total = 0
				for (var i=0; i<used_indices.length; i++) {				// loop through all base points
					if (peopleImpacted(used_indices[i]) != 'unknown') {	// if the number of people impacted is known (for it and all duplicates)
						total = total + numberWithoutCommas(peopleImpacted(used_indices[i]));	// add them up, making sure to 
					}													//	remove the commas from all numbers...
				}
				return total;			
			}
			
			function totalCapacity() {
				var total = 0
				for (var i=0; i<used_indices.length; i++) {
					total = total + numberWithoutCommas(storageInstalled(used_indices[i]));
				}
				return total;
			}
			
			function totalCeramic() {
				var total = 0
				for (var i=0; i<used_indices.length; i++) {
					total = total + numberWithoutCommas(filtersDistributed(used_indices[i]));
				}
				return total;
			}
			////////////////////////////////////////////////////////////////////////////////
			////					 	getLabel FUNCTION 							  	////
			//// 	Takes in the type of label to plot (string) and the index of the 	////
			////	marker's data in the global data array, data. Returns the string 	////
			////	that will be contained in the label. 								////
			////////////////////////////////////////////////////////////////////////////////
	
			function getLabel(data, i) {
				str = String(data[i][DATA_NAMES.name]);
				str = str.split(" ")
				var newStr = "";
				var lineCount = 1;
				for (var i=0; i<str.length; i++) {
					tempNewStr = newStr+"\xa0"+str[i]
					if(tempNewStr.length>MAX_LABEL_LINE_CHARS*lineCount & i!=0) {	
						newStr = newStr+"\xa0\n\xa0"+str[i];
					} else {
					newStr = tempNewStr;
					}
				};
				return "\xa0"+newStr+"\xa0";	
			}
			
			
			////////////////////////////////////////////////////////////////////////////////
			////					 	removePoint FUNCTION 						  	////
			//// 			Removes the point stored at the index i.					////
			////////////////////////////////////////////////////////////////////////////////
			
			function removePoint(i) {
				map.removeLayer(base.Markers[i]); 
			}
			
			
			////////////////////////////////////////////////////////////////////
			////				functions fadeIn(el), fadeOut(el) 			////
			//// 															////
			////	Fades in or out the passed element by adjusting the 	////
			////	the div element's opacity in steps. Many thanks to:		////////////////////
			////	http://www.chrisbuttery.com/articles/fade-in-fade-out-with-javascript/ 	////	
			////	for this simple and lovely bit of js. Cheers! 							////
			////	If the div is visible, fadeIn does nothing. If it's not, fade out 		////	
			////	does nothing. 															////
			////////////////////////////////////////////////////////////////////////////////////
			
			function fadeOut(el){ 
				
				(function fade() {
					if ((el.style.opacity -= .09) < 0) {
						el.style.opacity = 0;
					} else {
						requestAnimationFrame(fade);
					}
				})();
				
				el.style.display = 'none';
			}
			
			function fadeIn(el){
			
				el.style.opacity = 0;
				el.style.display = 'block'; 
				
				(function fade() {
					var val = parseFloat(el.style.opacity);
					if (!((val += .075) > 1)) {
					el.style.opacity = val;
					requestAnimationFrame(fade);
					}
				})();
				
			}
			
			////////////////////////////////////////////////////////////////////////////////
			////					 	onKeypress FUNCTION 						  	////
			//// 			Closes the info panel if the user presses "esc".			////
			////////////////////////////////////////////////////////////////////////////////
			
			$(document).bind('keypress', function (event) {
				if(String(event.originalEvent.key) == "Escape") {
					goBack('esc');		
				}
			})
			
			function goBack(key) {
				if (key == 'x') {
					closePanel('lobby');
					closePanel('info_panel');
					hideSelectedMarker();
				} else if (lobby_active) {
					closePanel('lobby');
					hideSelectedMarker();
				} else if (info_panel_open && AllData[info_being_displayed].duplicates.length == 1) {
					closePanel('info_panel');
					hideSelectedMarker();
				} else if (info_panel_open) {
					showLobby(info_being_displayed);
					openPanel('lobby')
					closePanel('info_panel');
				}			
			}
			
			
			////////////////////////////////////////////////////////////////////////////////
			////		showSelectedMarker / hideSelectedMarker FUNCTIONs 			  	////
			//// 	Shows or hides the icon that indicates that a certain marker		////
			////	has been selected.													////
			////////////////////////////////////////////////////////////////////////////////
			
			function showSelectedMarker() {
				if (!active_marker_on) {
					var latLng = L.latLng([AllData[info_being_displayed][DATA_NAMES.lat], AllData[info_being_displayed][DATA_NAMES.lng]]); // Grab the latLng of the point
					activeMarker = L.marker(latLng, {
										icon: selectedIcon,
										riseOnHover: true,
										zIndexOffset: BASE_Z_OFFSET
									})
					activeMarker.addTo(map);
					active_marker_on = true;
				}
			}
			
			function hideSelectedMarker() {
				if (active_marker_on) {
					if (info_being_displayed != -1) {
						map.removeLayer(activeMarker);
					}
					active_marker_on = false;
				}
			}
			
			function formatDate(start, end) {
				var e = String(end).split("/", 3);
				var s = String(start).split("/", 3);
				if (start == "") {
					date = e[1]+"/"+MONTHS[Number(e[0])]+"/"+e[2];
				}
				if (end == "") {
					date = s[1]+"/"+MONTHS[Number(s[0])]+"/"+s[2];
				}
				else {
					date_end = e[1]+"/"+MONTHS[Number(e[0])]+"/"+e[2];
					date_start = s[1]+"/"+MONTHS[Number(s[0])]+"/"+s[2];
					date = date_start+" - "+date_end;	
				}	
				return date
			}
			
			////////////////////////////////////////////////////////////////////
			////			function numberWith(out)Commas		 			////
			//// 															////
			////	Adds commas between every 3rd digit for the standard 	////
			////	US/Mexico numerical display format. Returns the number  ////
			//// 	as a string.											////
			////	The Without function does the reverse (takes in a 		////
			////	string that could have commas, removes them, and returns////
			////	a numerical value, either a float or an int).			////
			////////////////////////////////////////////////////////////////////
										
			function numberWithCommas(x) {
				return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
			}
			
			function numberWithoutCommas(x) {
				return Number(x.replace(/,/g, ''));
			}
			
			////////////////////////////////////////////////////////////////////
			////			function getScrollBarWidth		 				////
			//// 															////
			////	gets the width of a vertical scrollbar by making some	////
			////	invisible divs.											////
			////////////////////////////////////////////////////////////////////
			
			function getScrollBarWidth () {
				var inner = document.createElement('p');
				inner.style.width = "100%";
				inner.style.height = "200px";
				
				var outer = document.createElement('div');
				outer.style.position = "absolute";
				outer.style.top = "0px";
				outer.style.left = "0px";
				outer.style.visibility = "hidden";
				outer.style.width = "200px";
				outer.style.height = "150px";
				outer.style.overflow = "hidden";
				outer.appendChild (inner);
				
				document.body.appendChild (outer);
				var w1 = inner.offsetWidth;
				outer.style.overflow = 'scroll';
				var w2 = inner.offsetWidth;
				if (w1 == w2) w2 = outer.clientWidth;
				
				document.body.removeChild (outer);
				
				return (w1 - w2);
			};
			
			////////////////////////////////////////////////////////////////////
			////			function enable/disableMapControls 				////
			//// 															////
			////	Disables and enables panning, zooming, and all keyboard	////
			////	map controls when the cursor is and isn't over the map.	////
			////////////////////////////////////////////////////////////////////
			
			
			function disableMapControls() {
				map.dragging.disable();
				map.touchZoom.disable();
				map.doubleClickZoom.disable();
				map.scrollWheelZoom.disable();
				map.boxZoom.disable();
				map.keyboard.disable();
				if (map.tap) map.tap.disable();
				document.getElementById('WaterMap').style.cursor='default';
			}
			
			function enableMapControls() {
				map.dragging.enable();
				map.touchZoom.enable();
				map.doubleClickZoom.enable();
				map.scrollWheelZoom.enable();
				map.boxZoom.enable();
				map.keyboard.enable();
				if (map.tap) map.tap.enable();
				document.getElementById('WaterMap').style.cursor='grab';
			}
			
		</script>
		
	</body>
</html>
			
